name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-backend:
    name: Build Backend (Node.js)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: |
          cd backend
          npm ci

      - name: Build Backend
        run: |
          cd backend
          npm run build --if-present
        env:
          CI: false

  build-frontend:
    name: Build Frontend (React)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Build Frontend
        run: |
          cd frontend
          npm run build
        env:
          CI: false

  deploy:
    name: DÃ©ploiement sur EC2 avec Docker
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build-backend, build-frontend]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.GPIT_KEY }}
          port: 22
          timeout: 600s
          script: |
            set -e
            echo "ğŸš€ Starting deployment at $(date)..."
            
            # Installation Docker si nÃ©cessaire
            if ! command -v docker &> /dev/null; then
              echo "ğŸ³ Installing Docker..."
              sudo apt-get update
              sudo apt-get install -y docker.io
              sudo systemctl start docker
              sudo systemctl enable docker
            fi

            if ! command -v docker-compose &> /dev/null; then
              echo "ğŸ“¦ Installing Docker Compose..."
              sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi

            echo "âœ… Docker version: $(docker --version)"
            echo "âœ… Docker Compose version: $(docker-compose --version)"
            
            cd ~
            
            # Cleanup
            if [ -d "gpit" ]; then
              echo "ğŸ—‘ï¸ Removing old deployment..."
              sudo rm -rf gpit
            fi
            
            # Clone repo
            echo "ğŸ“¥ Cloning repository..."
            git clone https://github.com/EmnaMansour/gpit.git
            cd gpit
            
            # Create environment files
            echo "ğŸ”§ Setting up environment files..."
            
            # Backend .env - MongoDB ATLAS
            cat > ./backend/.env << 'EOF'
            MONGO_URI=mongodb+srv://emna:emna@cluster0.yq5crni.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0
            PORT=8000
            JWT_SECRET=emna
            EMAIL_USER=emnamansour77@gmail.com
            EMAIL_PASS=xzjcsupzgxxhupbb
            NODE_ENV=production
            EOF
            
            echo "ğŸ“‹ Environment files created successfully"
            
            # Docker deployment
            echo "ğŸ³ Starting Docker deployment..."
            
            # ArrÃªter les containers existants
            echo "ğŸ”» Stopping existing containers..."
            sudo docker-compose down -v --remove-orphans 2>/dev/null || true
            
            # Nettoyer Docker
            echo "ğŸ§¹ Cleaning Docker system..."
            sudo docker system prune -af --volumes 2>/dev/null || true
            
            # Builder les images
            echo "ğŸ—ï¸ Building Docker images..."
            sudo docker-compose build --no-cache
            
            # DÃ©marrer les services
            echo "ğŸš€ Starting services..."
            sudo docker-compose up -d
            
            # Attendre le dÃ©marrage
            echo "â³ Waiting for services to start..."
            sleep 45
            
            # VÃ©rifier l'Ã©tat
            echo "ğŸ“Š Container status:"
            sudo docker-compose ps
            
            # Health checks
            echo "ğŸ¥ Performing health checks..."
            
            # Test Backend
            if curl -s -f http://localhost:8081/health > /dev/null; then
              echo "âœ… Backend is healthy"
            else
              echo "âš ï¸ Backend health check failed"
              sudo docker-compose logs backend --tail=20
            fi
            
            # Test Frontend
            if curl -s -f http://localhost:5173 > /dev/null; then
              echo "âœ… Frontend is healthy"
            else
              echo "âš ï¸ Frontend health check failed"
            fi
            
            echo ""
            echo "ğŸ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
            echo "ğŸ“… Completed at: $(date)"
            echo "ğŸŒ Application URLs:"
            echo "   â€¢ Frontend: http://44.210.225.211:5173"
            echo "   â€¢ Backend:  http://44.210.225.211:8081"
            echo "   â€¢ Grafana:  http://44.210.225.211:3000"

      - name: Final Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… All jobs completed successfully!"
            echo "ğŸ‰ Your application is deployed and running!"
            echo ""
            echo "ğŸ“± Access your application:"
            echo "   Frontend: http://${{ secrets.EC2_HOST }}:5173"
            echo "   Backend:  http://${{ secrets.EC2_HOST }}:8081"
            echo "   Grafana:  http://${{ secrets.EC2_HOST }}:3000"
          else
            echo "âŒ Deployment failed - check the logs above"
          fi