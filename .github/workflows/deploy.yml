name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  debug-connection:
    name: ğŸ” Debug SSH Connection
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Check EC2 Status
        run: |
          echo "ğŸ” Debugging EC2 Connection..."
          echo "EC2 Host: ${{ secrets.EC2_HOST }}"
          echo "Username: ubuntu"
          echo ""
          echo "ğŸ“‹ Testing basic connectivity..."
          
          # Test ping
          if ping -c 2 ${{ secrets.EC2_HOST }} &>/dev/null; then
            echo "âœ… Ping successful - host is reachable"
          else
            echo "âŒ Ping failed - host may be down"
          fi
          
          # Test SSH port
          if nc -z -w 5 ${{ secrets.EC2_HOST }} 22 &>/dev/null; then
            echo "âœ… Port 22 is open"
          else
            echo "âŒ Port 22 is closed or blocked"
          fi

  deploy:
    name: ğŸš€ Deploy Application
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: debug-connection
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Simple SSH Test
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.GPIT_KEY }}
          port: 22
          timeout: 60s
          script: |
            echo "ğŸ‰ SUCCESS! SSH connection works!"
            echo "System info:"
            uname -a
            echo "âœ… Ready for deployment"

      - name: Quick Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.GPIT_KEY }}
          port: 22
          timeout: 300s
          script: |
            set -e
            echo "ğŸš€ QUICK DEPLOYMENT STARTING..."
            
            cd ~
            sudo rm -rf gpit
            git clone https://github.com/EmnaMansour/gpit.git
            cd gpit
            
            # Quick environment setup
            cat > ./backend/.env << 'EOF'
            MONGO_URI=mongodb+srv://emna:emna@cluster0.yq5crni.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0
            PORT=8000
            JWT_SECRET=emna
            EMAIL_USER=emnamansour77@gmail.com
            EMAIL_PASS=xzjcsupzgxxhupbb
            NODE_ENV=production
            EOF
            
            cat > ./frontend/.env << 'EOF'
            VITE_API_URL=http://44.210.225.211:8081/api
            EOF
            
            # Quick deploy
            sudo docker-compose down 2>/dev/null || true
            sudo docker-compose up -d mongo backend frontend --build
            
            sleep 30
            echo "âœ… DEPLOYMENT COMPLETE!"
            echo "Frontend: http://44.210.225.211:5173"
            echo "Backend: http://44.210.225.211:8081"

      - name: Success Message
        if: success()
        run: |
          echo "ğŸ‰ ğŸ‰ ğŸ‰ SUCCESS! ğŸ‰ ğŸ‰ ğŸ‰"
          echo "Your application is LIVE!"
          echo "ğŸŒ Frontend: http://${{ secrets.EC2_HOST }}:5173"
          echo "ğŸ”§ Backend: http://${{ secrets.EC2_HOST }}:8081"

      - name: Failure Help
        if: failure()
        run: |
          echo "âŒ SSH Connection Failed"
          echo ""
          echo "ğŸš¨ URGENT - Check these NOW:"
          echo "1. ğŸŒ Go to AWS Console > EC2"
          echo "2. ğŸ”’ Check Security Group - Port 22 MUST be open to 0.0.0.0/0"
          echo "3. ğŸ–¥ï¸ Instance must be 'Running' with '2/2 status checks'"
          echo "4. ğŸ”‘ Test manually: ssh -i key.pem ubuntu@${{ secrets.EC2_HOST }}"
          echo "5. ğŸ“§ If stuck, contact AWS support or create new EC2 instance"