name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: DÃ©ploiement sur EC2
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test SSH Connection
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.GPIT_KEY }}
          port: 22
          timeout: 60s
          script: |
            echo "âœ… SSH Connection successful!"
            echo "ğŸ“Š System info:"
            uname -a
            echo "ğŸ³ Docker info:"
            docker --version
            docker-compose --version

      - name: Deploy Application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.GPIT_KEY }}
          port: 22
          timeout: 300s
          script: |
            set -e
            echo "ğŸš€ Starting deployment at $(date)..."
            
            cd ~
            
            # Cleanup
            if [ -d "gpit" ]; then
              echo "ğŸ—‘ï¸ Removing old deployment..."
              sudo rm -rf gpit
            fi
            
            # Clone repo
            echo "ğŸ“¥ Cloning repository..."
            git clone https://github.com/EmnaMansour/gpit.git
            cd gpit
            
            # Create environment files
            echo "ğŸ”§ Setting up environment files..."
            
            # Backend .env - CORRIGÃ‰ pour utiliser la base 'test'
            cat > ./backend/.env << EOF
            MONGO_URI=mongodb://emna:emna@mongo:27017/test?authSource=admin
            PORT=8000
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            EMAIL_USER=${{ secrets.EMAIL_USER }}
            EMAIL_PASS=${{ secrets.EMAIL_PASS }}
            NODE_ENV=production
            EOF
            
            # Frontend .env
            cat > ./frontend/.env << EOF
            VITE_API_URL=http://44.210.225.211:8081/api
            EOF
            
            echo "ğŸ“‹ Environment files created successfully"
            
            # Docker deployment
            echo "ğŸ³ Starting Docker deployment..."
            
            # Stop and clean
            echo "ğŸ”» Stopping existing containers..."
            sudo docker-compose down -v --remove-orphans 2>/dev/null || true
            
            # Clean Docker system
            echo "ğŸ§¹ Cleaning Docker system..."
            sudo docker system prune -af --volumes 2>/dev/null || true
            
            # Build core services only (avoid problematic services)
            echo "ğŸ—ï¸ Building core services..."
            sudo docker-compose build mongo backend frontend
            
            echo "ğŸš€ Starting core services..."
            sudo docker-compose up -d mongo backend frontend
            
            # Wait for services to start
            echo "â³ Waiting for services to start..."
            sleep 30
            
            # Check MongoDB connection
            echo "ğŸ” Testing MongoDB connection..."
            sudo docker-compose exec mongo mongosh --eval "db.adminCommand('listDatabases')" || echo "MongoDB check failed"
            
            # Check service status
            echo "ğŸ“Š Service status:"
            sudo docker-compose ps
            
            echo "ğŸ” Checking backend logs:"
            sudo docker-compose logs backend --tail=20
            
            echo "ğŸ” Checking MongoDB logs:"
            sudo docker-compose logs mongo --tail=10
            
            # Health checks
            echo "ğŸ¥ Performing health checks..."
            curl -f http://localhost:8081/ > /dev/null 2>&1 && echo "âœ… Backend is healthy" || echo "âŒ Backend health check failed"
            curl -f http://localhost:5173/ > /dev/null 2>&1 && echo "âœ… Frontend is healthy" || echo "âŒ Frontend health check failed"
            
            echo ""
            echo "âœ… Deployment completed successfully at $(date)!"
            echo "ğŸŒ Application URLs:"
            echo "   Frontend: http://44.210.225.211:5173"
            echo "   Backend:  http://44.210.225.211:8081"
            echo "   MongoDB:  http://44.210.225.211:27017"

      - name: Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment succeeded!"
            echo "ğŸ‰ Your application is now live at:"
            echo "   Frontend: http://44.210.225.211:5173"
            echo "   Backend:  http://44.210.225.211:8081"
          else
            echo "âŒ Deployment failed!"
            echo "ğŸ”§ Troubleshooting steps:"
            echo "1. Check AWS Security Group for port 22"
            echo "2. Verify EC2 instance is running"
            echo "3. Ensure SSH key is correct in GitHub secrets"
            echo "4. Check if username is 'ubuntu' or 'ec2-user'"
          fi