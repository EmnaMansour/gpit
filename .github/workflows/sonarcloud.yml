name: CI/CD Pipeline - Cypress + Coverage + SonarCloud + EC2 Deployment

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  cypress-sonarcloud-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout repo
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2ï¸âƒ£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # 3ï¸âƒ£ Install dependencies (frontend + backend)
      - name: Install dependencies
        run: |
          npm ci
          cd backend && npm ci

      # 4ï¸âƒ£ Setup Cypress code coverage
      - name: Setup Cypress coverage
        run: |
          npm install --save-dev @cypress/code-coverage nyc
          cd backend && npm install --save-dev nyc

      # 5ï¸âƒ£ Start frontend Vite server
      - name: Start Vite server
        run: |
          npm run dev -- --host 0.0.0.0 --port 5173 &
          echo "Vite started in background..."

      # 6ï¸âƒ£ Wait for Vite to be ready
      - name: Wait for Vite server
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 10
          command: npx wait-on http://localhost:5173

      # 7ï¸âƒ£ Run Cypress tests with coverage
      - name: Run Cypress tests
        env:
          CYPRESS_COVERAGE: 1
        run: npx cypress run

      # 8ï¸âƒ£ Run backend tests with coverage
      - name: Run backend tests with coverage
        run: |
          cd backend
          npx nyc --reporter=lcov --report-dir=coverage npm test

      # 9ï¸âƒ£ Generate LCOV report (frontend)
      - name: Generate frontend LCOV
        run: |
          npx nyc report --reporter=lcov --report-dir=frontend/coverage
          sed -i 's|SF:.*/src/|SF:src/|g' frontend/coverage/lcov.info
          head -20 frontend/coverage/lcov.info

      # ğŸ”Ÿ Generate LCOV report (backend)
      - name: Generate backend LCOV
        run: |
          sed -i 's|SF:.*/backend/src/|SF:backend/src/|g' backend/coverage/lcov.info
          head -20 backend/coverage/lcov.info

      # 1ï¸âƒ£1ï¸âƒ£ SonarCloud scan
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=EmnaMansour_gpit
            -Dsonar.organization=emnamansour
            -Dsonar.sources=frontend/src,backend/src
            -Dsonar.tests=frontend/src,backend/src
            -Dsonar.javascript.lcov.reportPaths=frontend/coverage/lcov.info,backend/coverage/lcov.info
            -Dsonar.typescript.lcov.reportPaths=frontend/coverage/lcov.info,backend/coverage/lcov.info
            -Dsonar.coverage.exclusions=**/*.test.ts,**/*.spec.ts,cypress/**,jest-tests/**,coverage/**
            -Dsonar.sourceEncoding=UTF-8

      # 1ï¸âƒ£2ï¸âƒ£ Deploy to EC2 via SSH
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.GPIT_KEY }}
          port: 22
          timeout: 600s
          script: |
            set -e
            echo "ğŸš€ Starting deployment at $(date)..."

            # Installer Docker si nÃ©cessaire
            if ! command -v docker &> /dev/null; then
              echo "ğŸ³ Installing Docker..."
              sudo apt-get update
              sudo apt-get install -y docker.io
              sudo systemctl start docker
              sudo systemctl enable docker
            fi

            if ! command -v docker-compose &> /dev/null; then
              echo "ğŸ“¦ Installing Docker Compose..."
              sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi

            echo "âœ… Docker version: $(docker --version)"
            echo "âœ… Docker Compose version: $(docker-compose --version)"

            cd ~

            # Cleanup
            if [ -d "gpit" ]; then
              echo "ğŸ—‘ï¸ Removing old deployment..."
              sudo rm -rf gpit
            fi

            # Clone repo
            echo "ğŸ“¥ Cloning repository..."
            git clone https://github.com/EmnaMansour/gpit.git
            cd gpit

            # Create backend .env
            echo "ğŸ”§ Setting up environment files..."
            cat > ./backend/.env << 'EOF'
MONGO_URI=${{ secrets.MONGO_URI }}
PORT=8000
JWT_SECRET=${{ secrets.JWT_SECRET }}
EMAIL_USER=${{ secrets.EMAIL_USER }}
EMAIL_PASS=${{ secrets.EMAIL_PASS }}
NODE_ENV=production
EOF

            echo "ğŸ“‹ Environment files created successfully"

            # Docker deployment
            echo "ğŸ³ Starting Docker deployment..."
            sudo docker-compose down -v --remove-orphans || true
            sudo docker system prune -af --volumes || true
            sudo docker-compose build --no-cache
            sudo docker-compose up -d

            echo "â³ Waiting for services to start..."
            sleep 45

            echo "ğŸ“Š Container status:"
            sudo docker-compose ps

            echo "ğŸ¥ Performing health checks..."
            if curl -s -f http://localhost:8081/health > /dev/null; then
              echo "âœ… Backend is healthy"
            else
              echo "âš ï¸ Backend health check failed"
              sudo docker-compose logs backend --tail=20
            fi

            if curl -s -f http://localhost:5173 > /dev/null; then
              echo "âœ… Frontend is healthy"
            else
              echo "âš ï¸ Frontend health check failed"
            fi

            echo "ğŸ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
            echo "ğŸ“… Completed at: $(date)"
