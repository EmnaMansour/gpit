name: CI/CD with Cypress Coverage and SonarCloud

on:
  push:
    branches:
      - main
  pull_request:

env:
  MONGO_URI: ${{ secrets.MONGO_URI }}
  JWT_SECRET: ${{ secrets.JWT_SECRET }}
  EMAIL_USER: ${{ secrets.EMAIL_USER }}
  EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

jobs:
  build-test-sonar:
    runs-on: ubuntu-latest
    services:
      mongo:
        image: mongo:6
        ports:
          - 27017:27017
        options: --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'" --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 20
        cache: 'npm'

    - name: Install dependencies
      run: |
        cd backend && npm ci
        cd ../frontend && npm ci

    - name: Start backend instrumented
      run: |
        cd backend
        npm run start:instrumented & 
        echo $! > backend.pid
        sleep 10

    - name: Run Cypress Tests with Coverage
      run: |
        cd frontend
        npx cypress run
        cd ../backend
        npx nyc report --reporter=lcov --report-dir=coverage
        # Fix paths for SonarCloud
        sed -i 's|SF:.*/src/|SF:src/|g' coverage/lcov.info

    - name: Stop backend
      run: |
        kill $(cat backend.pid) || true

    - name: SonarCloud Scan
      uses: sonarsource/sonarcloud-github-action@v2
      with:
        organization: ${{ secrets.SONAR_ORG }}
        projectKey: ${{ secrets.SONAR_PROJECT_KEY }}
        token: ${{ secrets.SONAR_TOKEN }}
        extraProperties: |
          sonar.sources=frontend/src,backend/src
          sonar.tests=frontend/src,backend/src
          sonar.javascript.lcov.reportPaths=frontend/coverage/lcov.info
          sonar.typescript.lcov.reportPaths=backend/coverage/lcov.info
          sonar.typescript.lcov.reportPaths=frontend/coverage/lcov.info
