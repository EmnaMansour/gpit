name: CI/CD GPIT - Backend Â· Frontend Â· Tests Â· Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test:
    name: Build & Test Backend and Frontend
    runs-on: ubuntu-latest

    services:
      mongo:
        image: mongo:6.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password
        ports: ["27017:27017"]
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      NODE_ENV: test
      MONGO_URI: ${{ secrets.MONGO_URI }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      EMAIL_USER: ${{ secrets.EMAIL_USER }}
      EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
      HUGGING_FACE_TOKEN: ${{ secrets.HUGGING_FACE_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      # Backend
      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Run backend tests
        working-directory: backend
        run: |
          npm test -- --runInBand --detectOpenHandles --coverage --watchAll=false || true
          if [ -f coverage/lcov.info ]; then echo "Backend coverage OK"; else echo "No backend coverage"; fi

      # Frontend
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Run frontend tests
        working-directory: frontend
        run: |
          npm test -- --runInBand --coverage --watchAll=false || true
          if [ -f coverage/lcov.info ]; then echo "Frontend coverage OK"; else echo "No frontend coverage"; fi

  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/main' && success()

    env:
      NODE_ENV: production
      MONGO_URI: ${{ secrets.MONGO_URI }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      EMAIL_USER: ${{ secrets.EMAIL_USER }}
      EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
      HUGGING_FACE_TOKEN: ${{ secrets.HUGGING_FACE_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Debug secrets (optionnel pour tester que GitHub Secrets sont bien lus)
      - name: Debug secrets
        run: |
          echo "Server IP: ${{ secrets.SERVER_IP }}"
          echo "Server User: ${{ secrets.SERVER_USER }}"

      - name: Deploy via SSH (docker-compose on server)
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            echo "ðŸš€ Starting deployment..."

            if [ ! -d "/var/www/gpit" ]; then
              echo "âŒ Directory /var/www/gpit does not exist!"
              exit 1
            fi

            cd /var/www/gpit
            echo "âœ… Changed directory to /var/www/gpit"

            echo "ðŸ“¦ Pulling latest images..."
            docker-compose pull || true

            echo "ðŸ›‘ Stopping current containers..."
            docker-compose down --remove-orphans || true

            echo "ðŸ”§ Building and starting containers..."
            docker-compose up -d --build --remove-orphans

            echo "â³ Waiting for backend to be ready..."
            for i in $(seq 1 12); do
              if curl -fsS http://localhost:8000/api/health >/dev/null 2>&1; then
                echo "âœ… Backend OK"
                break
              fi
              echo "Waiting server... ($i/12)"
              sleep 5
            done

            echo "ðŸŽ‰ Deployment completed successfully!"
