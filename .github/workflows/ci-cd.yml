name: CI/CD GPIT Docker + Cypress + SonarCloud

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_ENV: test

jobs:
  build-test-sonar:
    name: Build ¬∑ Test ¬∑ Cypress ¬∑ SonarCloud
    runs-on: ubuntu-latest

    services:
      mongo:
        image: mongo:6.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password
        ports:
          - 27017:27017
        # options must be a string for multi-arg flags
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      # ---------- BACKEND ----------
      - name: üì• Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: üß™ Run backend tests (jest + coverage)
        working-directory: backend
        run: |
          # ajoute --runInBand si tu as des probl√®mes de connexion Mongo depuis tests
          npm test -- --coverage --watchAll=false || true
          if [ -f coverage/lcov.info ]; then
            echo "coverage found"
          else
            echo "no backend coverage generated"
          fi

      # ---------- FRONTEND ----------
      - name: üì• Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: üß™ Run frontend tests (jest + coverage)
        working-directory: frontend
        run: |
          npm test -- --coverage --watchAll=false || true
          if [ -f coverage/lcov.info ]; then
            echo "frontend coverage found"
          else
            echo "no frontend coverage generated"
          fi

      # ---------- Optional: Build Docker images (can be removed if not needed) ----------
      - name: üê≥ Build Docker backend (optional)
        run: docker build -t gpit-backend ./backend

      - name: üê≥ Build Docker frontend (optional)
        run: docker build -t gpit-frontend ./frontend

      # ---------- Start backend in runner so Cypress can talk to it ----------
      - name: ‚ñ∂Ô∏è Start backend (local runner) for E2E
        working-directory: backend
        run: |
          # Use PORT 8000 (exposed on localhost)
          export PORT=8000
          # Ensure we connect to the service mongo (service is available at localhost:27017)
          export MONGO_URI="mongodb://admin:password@localhost:27017/gpit?authSource=admin"
          # Start the backend in background (should use a start script that runs node/server)
          npm run start &> backend-e2e.log &
          # Wait for the health endpoint
          for i in {1..30}; do
            if curl -f -s http://localhost:8000/api/health > /dev/null 2>&1; then
              echo "Backend is ready"
              break
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done
          curl -f http://localhost:8000/api/health || (echo "backend failed to start"; tail -n 200 backend-e2e.log; exit 1)

      # ---------- Start frontend for Cypress ----------
      - name: ‚ñ∂Ô∏è Start frontend (Vite) for E2E
        working-directory: frontend
        run: |
          npm run dev &> frontend-e2e.log &
          for i in {1..30}; do
            if curl -f -s http://localhost:5173 > /dev/null; then
              echo "Frontend is ready"
              break
            fi
            echo "Waiting for frontend... ($i/30)"
            sleep 2
          done
          curl -f http://localhost:5173 || (echo "frontend failed to start"; tail -n 200 frontend-e2e.log; exit 1)

      # ---------- Cypress E2E ----------
      - name: üß™ Cypress E2E tests
        uses: cypress-io/github-action@v5
        with:
          working-directory: frontend
          browser: chrome
          start: npm run dev
          wait-on: http://localhost:5173
          wait-on-timeout: 120

      # ---------- SonarCloud ----------
      - name: üóÇÔ∏è Cache SonarCloud
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: üîç SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: .
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectKey=gestion_parc_info
            -Dsonar.projectName="Gestion Parc Info"
            -Dsonar.sources=backend,frontend/src
            -Dsonar.tests=backend/__tests__,frontend/src/__tests__
            -Dsonar.javascript.lcov.reportPaths=backend/coverage/lcov.info,frontend/coverage/lcov.info
            -Dsonar.coverage.exclusions=**/node_modules/**,**/*.d.ts,**/cypress/**
            -Dsonar.qualitygate.wait=true

  deploy:
    name: Deploy to Production (SSH)
    runs-on: ubuntu-latest
    needs: build-test-sonar
    if: github.ref == 'refs/heads/main' && success()
    env:
      SERVER_IP: ${{ secrets.SERVER_IP }}

    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4

      - name: üîë SSH Deploy to Server
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            cd /var/www/gpit || exit 1
            echo "üîÑ Arr√™t des containers..."
            docker-compose down --remove-orphans || true
            echo "üì• Pull des nouvelles images..."
            docker-compose pull || true
            echo "üöÄ D√©marrage des services..."
            docker-compose up -d --remove-orphans
            echo "‚è≥ Attente du d√©marrage..."
      - name: üîç Test backend post-deploy
        run: |
          max_attempts=10
          attempt=1
          until curl -f -s http://$SERVER_IP:8000/api/health; do
            if [ $attempt -eq $max_attempts ]; then
              echo "‚ùå Backend non op√©rationnel apr√®s $max_attempts tentatives"
              exit 1
            fi
            echo "‚è≥ Tentative $attempt/$max_attempts..."
            sleep 10
            attempt=$((attempt + 1))
          done
          echo "‚úÖ Backend op√©rationnel"
          done
      - name: üîç Test frontend post-deploy
        run: |
          max_attempts=10
          attempt=1
          until curl -f -s http://$SERVER_IP; do
            if [ $attempt -eq $max_attempts ]; then
              echo "‚ùå Frontend non op√©rationnel apr√®s $max_attempts tentatives"
              exit 1
            fi
            echo "‚è≥ Tentative $attempt/$max_attempts..."
            sleep 10
            attempt=$((attempt + 1))
          done
          echo "‚úÖ Frontend op√©rationnel"
          done
          echo "‚úÖ Frontend op√©rationnel"
