name: CI/CD GPIT - Build · Test · Cypress · SonarCloud · Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_ENV: test

jobs:
  build-test-sonar:
    name: Build · Test · Cypress · SonarCloud
    runs-on: ubuntu-latest

    services:
      mongo:
        image: mongo:6.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password
        ports: ["27017:27017"]
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      # ---------- BACKEND ----------
      - name: Install backend deps
        working-directory: backend
        run: npm ci

      - name: Run backend tests (jest)
        working-directory: backend
        run: |
          # Use runInBand to avoid mongoose multiple-connect race conditions
          npm test -- --runInBand --detectOpenHandles --coverage --watchAll=false || true
          if [ -f coverage/lcov.info ]; then echo "backend coverage OK"; else echo "no backend coverage"; fi

      # ---------- FRONTEND ----------
      - name: Install frontend deps
        working-directory: frontend
        run: npm ci

      - name: Run frontend tests
        working-directory: frontend
        run: |
          npm test -- --runInBand --coverage --watchAll=false || true
          if [ -f coverage/lcov.info ]; then echo "frontend coverage OK"; else echo "no frontend coverage"; fi

      # ---------- Optional Docker build (for images to deploy) ----------
      - name: Build Docker backend image
        run: docker build -t gpit-backend:ci ./backend

      - name: Build Docker frontend image
        run: docker build -t gpit-frontend:ci ./frontend

      # ---------- Start backend locally for Cypress E2E ----------
      - name: Start backend for E2E
        working-directory: backend
        run: |
          export PORT=8000
          export MONGO_URI="mongodb://admin:password@localhost:27017/gpit?authSource=admin"
          npm start &> backend-e2e.log &
          for i in {1..30}; do
            if curl -fsS http://localhost:8000/api/health >/dev/null 2>&1; then
              echo "backend ready"; break
            fi
            echo "waiting backend... ($i/30)"; sleep 2
          done
          curl -fsS http://localhost:8000/api/health || (echo "backend start failed"; tail -n 200 backend-e2e.log; exit 1)

      - name: Start frontend for E2E (Vite)
        working-directory: frontend
        run: |
          npm run build
          # serve the static build quickly using serve package (install temporarily)
          npm i -g serve
          serve -s dist -l 5173 &> frontend-e2e.log &
          for i in {1..30}; do
            if curl -fsS http://localhost:5173 >/dev/null 2>&1; then echo "frontend ready"; break; fi
            echo "waiting frontend... ($i/30)"; sleep 2
          done
          curl -fsS http://localhost:5173 || (echo "frontend start failed"; tail -n 200 frontend-e2e.log; exit 1)

      - name: Cypress E2E tests
        uses: cypress-io/github-action@v5
        with:
          working-directory: frontend
          browser: chrome
          wait-on: http://localhost:5173
          wait-on-timeout: 120

      # ---------- SonarCloud ----------
      - name: Cache Sonar
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: .
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectKey=gestion_parc_info
            -Dsonar.projectName="Gestion Parc Info"
            -Dsonar.sources=backend,frontend/src
            -Dsonar.tests=backend/__tests__,frontend/src/__tests__
            -Dsonar.javascript.lcov.reportPaths=backend/coverage/lcov.info,frontend/coverage/lcov.info
            -Dsonar.coverage.exclusions=**/node_modules/**,**/*.d.ts,**/cypress/**

  deploy:
    name: Deploy to production (SSH)
    runs-on: ubuntu-latest
    needs: build-test-sonar
    if: github.ref == 'refs/heads/main' && success()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build & push images (optional, if you use registry)
        run: echo "Skip or add docker push to registry here"

      - name: Deploy via SSH (docker-compose on server)
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /var/www/gpit || exit 1
            docker-compose pull || true
            docker-compose down --remove-orphans || true
            docker-compose up -d --build --remove-orphans
            # wait health
            for i in $(seq 1 12); do
              if curl -fsS http://localhost:8000/api/health >/dev/null 2>&1; then echo "backend OK"; break; fi
              echo "waiting server... ($i/12)"; sleep 5
            done
