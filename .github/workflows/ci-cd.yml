name: CI/CD GPIT Docker + Cypress + SonarCloud

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_ENV: test

jobs:
  build-test-sonar:
    runs-on: ubuntu-latest
    
    services:
      mongo:
        image: mongo:6.0
        ports: [27017:27017]
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ğŸ”‘ Essentiel pour SonarCloud

      # 2ï¸âƒ£ Setup Node.js
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      # 3ï¸âƒ£ Install dependencies
      - name: ğŸ“¥ Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: ğŸ“¥ Install frontend dependencies
        working-directory: frontend
        run: npm ci

      # 4ï¸âƒ£ Build Docker images
      - name: ğŸ³ Build Docker backend
        run: docker build -t gpit-backend ./backend

      - name: ğŸ³ Build Docker frontend
        run: docker build -t gpit-frontend ./frontend

      # 5ï¸âƒ£ Run backend container for Cypress
      - name: â–¶ï¸ Run backend container
        run: |
          docker run -d --name gpit-backend-test -p 8000:8000 \
            -e MONGO_URI=mongodb://admin:password@localhost:27017/gpit \
            gpit-backend
          sleep 15
          curl -f http://localhost:8000/api/health || echo "Backend starting..."

      # 6ï¸âƒ£ Cypress E2E tests
      - name: ğŸ§ª Cypress E2E tests
        uses: cypress-io/github-action@v5
        with:
          start: docker run -d -p 5173:5173 gpit-frontend
          wait-on: http://localhost:5173
          wait-on-timeout: 120
          browser: chrome
          working-directory: frontend

      # 7ï¸âƒ£ Cache SonarCloud
      - name: ğŸ—‚ï¸ Cache SonarCloud
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      # 8ï¸âƒ£ SonarCloud analysis
      - name: ğŸ” SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: .
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectKey=gestion_parc_info
            -Dsonar.projectName="Gestion Parc Info"
            -Dsonar.sources=backend,frontend/src
            -Dsonar.tests=backend/__tests__,frontend/src/__tests__
            -Dsonar.javascript.lcov.reportPaths=backend/coverage/lcov.info,frontend/coverage/lcov.info
            -Dsonar.coverage.exclusions=**/node_modules/**,**/*.d.ts,**/cypress/**,**/dist/**
            -Dsonar.qualitygate.wait=true

# Le job deploy reste identique
deploy:
  name: ğŸš€ Deploy to Production
  runs-on: ubuntu-latest
  needs: build-test-sonar
  if: github.ref == 'refs/heads/main' && success()
  
  steps:
    - name: ğŸ“¦ Checkout repository
      uses: actions/checkout@v4

    # Deploy via SSH
    - name: ğŸ”‘ SSH Deploy to Server
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          cd /var/www/gpit
          echo "ğŸ”„ ArrÃªt des containers..."
          docker-compose down
          echo "ğŸ“¥ Pull des nouvelles images..."
          docker-compose pull
          echo "ğŸš€ DÃ©marrage des services..."
          docker-compose up -d --remove-orphans
          echo "â³ Attente du dÃ©marrage..."
          sleep 30

    # Test backend post-deploy
    - name: ğŸ” Test backend post-deploy
      run: |
        echo "ğŸ§ª Test du backend sur ${{ secrets.SERVER_IP }}:8000"
        max_attempts=10
        attempt=1
        until curl -f -s http://${{ secrets.SERVER_IP }}:8000/api/health; do
          if [ $attempt -eq $max_attempts ]; then
            echo "âŒ Backend non opÃ©rationnel aprÃ¨s $max_attempts tentatives"
            exit 1
          fi
          echo "â³ Tentative $attempt/$max_attempts..."
          sleep 10
          attempt=$((attempt + 1))
        done
        echo "âœ… Backend opÃ©rationnel"

    # Test frontend post-deploy
    - name: ğŸ” Test frontend post-deploy
      run: |
        echo "ğŸ§ª Test du frontend sur ${{ secrets.SERVER_IP }}"
        max_attempts=10
        attempt=1
        until curl -f -s http://${{ secrets.SERVER_IP }}; do
          if [ $attempt -eq $max_attempts ]; then
            echo "âŒ Frontend non opÃ©rationnel aprÃ¨s $max_attempts tentatives"
            exit 1
          fi
          echo "â³ Tentative $attempt/$max_attempts..."
          sleep 10
          attempt=$((attempt + 1))
        done
        echo "âœ… Frontend opÃ©rationnel"
